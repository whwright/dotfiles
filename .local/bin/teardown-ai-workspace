#!/usr/bin/env bash

set -euo pipefail

session_name="${1:-}"

if [[ -z "$session_name" ]]; then
    echo "Error: Session name is required." >&2
    echo "Usage: teardown-ai-workspace <session_name>" >&2
    exit 1
fi

if ! tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' does not exist, nothing to tear down."
    exit 0
fi

echo "Tearing down session '$session_name'..."

# Wait for a process to exit with timeout
# Returns 0 if process exited, 1 if timeout
wait_for_exit() {
    local pane="$1"
    local pattern="$2"
    local timeout="${3:-5}"
    local elapsed=0

    while [[ $elapsed -lt $timeout ]]; do
        # Check if pane still exists
        if ! tmux list-panes -t "$pane" &>/dev/null; then
            return 0
        fi

        local cmd
        cmd=$(tmux list-panes -t "$pane" -F '#{pane_current_command}' 2>/dev/null || echo "")

        if [[ -z "$cmd" ]] || ! echo "$cmd" | grep -qi "$pattern"; then
            return 0
        fi

        sleep 0.5
        elapsed=$((elapsed + 1))
    done

    return 1
}

# Get all panes in the session
panes=$(tmux list-panes -t "$session_name" -F '#{pane_id}' 2>/dev/null || echo "")

if [[ -z "$panes" ]]; then
    echo "No panes found, killing session..."
    tmux kill-session -t "$session_name" 2>/dev/null || true
    echo "Session '$session_name' torn down."
    exit 0
fi

# Process each pane based on what's running
for pane_id in $panes; do
    # Get the current command running in this pane
    current_cmd=$(tmux list-panes -t "$pane_id" -F '#{pane_current_command}' 2>/dev/null || echo "")

    if [[ -z "$current_cmd" ]]; then
        continue
    fi

    if echo "$current_cmd" | grep -qi 'python\|flask'; then
        echo "Stopping flask shell in pane $pane_id..."
        tmux send-keys -t "$pane_id" C-d
        sleep 0.3
        tmux send-keys -t "$pane_id" 'y' C-m

        if wait_for_exit "$pane_id" 'python\|flask' 5; then
            echo "Flask shell stopped."
        else
            echo "Flask shell did not exit cleanly, continuing..."
        fi

    elif echo "$current_cmd" | grep -qi 'node\|claude'; then
        echo "Stopping claude in pane $pane_id..."
        tmux send-keys -t "$pane_id" '/exit' C-m
        sleep 0.5

        if wait_for_exit "$pane_id" 'node\|claude' 5; then
            echo "Claude stopped."
        else
            echo "Claude did not exit cleanly, continuing..."
        fi
    fi
done

# Kill the entire tmux session
echo "Closing session..."
tmux kill-session -t "$session_name" 2>/dev/null || true

echo "Session '$session_name' torn down successfully."
