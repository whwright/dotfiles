#!/usr/bin/env bash

set -euo pipefail

session_name="${1:-}"

if [[ -z "$session_name" ]]; then
    echo "Error: Session name is required." >&2
    echo "Usage: teardown-ai-workspace <session_name>" >&2
    exit 1
fi

if ! tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Error: tmux session '$session_name' does not exist." >&2
    exit 1
fi

echo "Tearing down session '$session_name'..."

# Count panes to determine layout
pane_count=$(tmux list-panes -t "$session_name:0" | wc -l | tr -d ' ')

if [[ "$pane_count" -ge 3 ]]; then
    # 3-pane layout: shell, flask, claude
    # Check if pane 1 is running flask/python
    if tmux list-panes -t "$session_name:0.1" -F '#{pane_current_command}' 2>/dev/null | grep -qi 'python\|flask'; then
        echo "Stopping flask shell..."
        tmux send-keys -t "$session_name:0.1" C-d
        sleep 0.5
        tmux send-keys -t "$session_name:0.1" 'y' C-m

        # Wait for flask shell to exit
        while tmux list-panes -t "$session_name:0.1" -F '#{pane_current_command}' 2>/dev/null | grep -qi 'python\|flask'; do
            sleep 0.5
        done
        echo "Flask shell stopped."
    fi

    # Claude is in pane 2
    claude_pane="$session_name:0.2"
else
    # 2-pane layout: shell, claude
    # Claude is in pane 1
    claude_pane="$session_name:0.1"
fi

# Kill claude
echo "Stopping claude..."
tmux send-keys -t "$claude_pane" '/exit' C-m
tmux send-keys -t "$claude_pane" C-m
sleep 1

# Wait for claude to exit
while tmux list-panes -t "$claude_pane" -F '#{pane_current_command}' 2>/dev/null | grep -qi 'claude\|node'; do
    sleep 0.5
done
echo "Claude stopped."

# Kill the entire tmux session
echo "Closing session..."
tmux kill-session -t "$session_name"

echo "Session '$session_name' torn down successfully."
